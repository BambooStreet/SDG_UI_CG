  # 시민 세팅
    def _step1_citizen_association(self, category: str, keyword: str) -> str:
        """제시어를 보고 관련된 구체적 이미지/경험 떠올리기"""
        system = "당신은 연상 능력이 뛰어난 보조 작가입니다."
        user = f"""
        제시어: '{keyword}' (카테고리: {category})
        
        이 제시어와 관련된 '구체적인 상황', '문화적 코드(드라마/영화)', '직업병', '속설'을 5가지 나열하세요.
        단, 제시어 단어 자체는 절대 쓰지 마세요.
        """
        return self._call_llm(system, user, temp=0.8)

    def _step2_citizen_abstraction(self, category: str, ideas: str, history: dict) -> str:
        history_text = "\n".join([f"- {n}: {d}" for n, d in history.items()])
        
        system = "당신은 '라이어 게임'의 초고수입니다. 시민끼리만 통하는 은밀한 신호를 보내야 합니다."
        user = f"""
        [연상된 소재들]
        {ideas}
        
        [미션]
        위 소재 중 하나를 골라 **'상황'이나 '개인적 감상'**으로 바꾸세요.
        
        [🚨 절대 금지어 규칙]
        1. **제시어를 직접 지칭하는 단어 금지** (예: 의사면 '환자/병원/수술' 금지 -> '그 사람들/그곳/일'로 대체)
        2. 사전적 정의 금지 ("사람을 고치는 사람" -> 탈락)
        
        [다른 사람들의 설명]
        {history_text}
        
        선택한 소재를 바탕으로 **시민만 알 수 있는 문장 개념** 하나만 출력하세요.
        """
        return self._call_llm(system, user, temp=0.8)

    # 라이어 세팅
    def _step1_liar_scanning(self, category: str, history: dict) -> str:
        """앞사람들의 설명에서 공통된 분위기나 키워드 추출"""
        if not history:
            return "정보 없음(첫 번째 순서). 카테고리의 일반적인 특성에 의존해야 함."
            
        history_text = "\n".join([f"- {n}: {d}" for n, d in history.items()])
        
        system = "당신은 눈치가 매우 빠른 관찰자입니다."
        user = f"""
        주제: '{category}'
        
        [다른 사람들의 설명]
        {history_text}
        
        위 설명들을 분석하여 공통적으로 느껴지는 **'분위기', '감정', '맥락'**을 요약하세요.
        (예: 다들 '힘들다'고 함, 다들 '맛' 이야기를 함, 다들 '어릴 때 추억'을 이야기함)
        """
        return self._call_llm(system, user, temp=0.5) # 분석은 정확해야 하므로 온도 낮음

    def _step2_liar_strategy(self, category: str, analysis: str) -> str:
        """분석된 분위기에 맞춰 가장 안전한 거짓말 소재 선정"""
        system = "당신은 임기응변에 능한 사기꾼입니다."
        user = f"""
        주제: '{category}'
        [분석된 분위기]
        {analysis}
        
        [미션]
        위 분위기에 자연스럽게 녹아들면서도, 구체적인 사실 관계를 피할 수 있는 **'가장 안전한 멘트 소재'**를 하나 만드세요.
        
        [전략]
        - 만약 정보가 없다면(첫 순서라면), 해당 카테고리 어디에나 쓸 수 있는 "호불호가 갈린다"나 "관리가 어렵다" 같은 말을 선택하세요.
        - 남들이 '힘들다'고 하면 -> "맞아, 체력이 필수지" 식으로 동조하는 소재를 잡으세요.
        
        **거짓말 소재 하나만** 짧게 출력하세요.
        """
        return self._call_llm(system, user, temp=0.9) # 거짓말은 창의적이어야 함

    # 공통 세팅
    def _step3_articulation(self, concept: str) -> str:
        """개념을 자연스러운 한국어 말로 변환"""
        system = f"당신은 게임 플레이어 '{self.name}'입니다. 한국어 구어체(반말)를 씁니다."
        user = f"""
        당신이 말해야 할 내용: "{concept}"
        
        위 내용을 자연스러운 **대화체 한 문장**으로 말하세요.
        
        [조건]
        1. "내 생각에는~" 같은 사족 금지.
        2. 친구랑 대화하듯 자연스러운 반말 사용.
        3. 20자 내외로 짧게.
        
        출력:
        """
        return self._call_llm(system, user, temp=0.9)
    # def generate_description(self, category: str, keyword: str, history: dict) -> str:
    #     # 입력 데이터 정제
    #     category = self._sanitize_text(category)
    #     keyword = self._sanitize_text(keyword)
        
    #     # history의 내용도 정제
    #     history_text = "\n".join([f"- {name}: {self._sanitize_text(desc)}" for name, desc in history.items()])
    #     if not history_text:
    #         history_text = "(당신이 첫 번째 순서입니다.)"
        
    #     # [1. 시스템 프롬프트: 게임 규칙과 역할을 명확히 주입]
    #     system_prompt = f"""
    #     당신은 '라이어 게임'을 하고 있는 플레이어 '{self.name}'입니다.
        
    #     [게임 규칙]
    #     1. 참가자들은 '{category}' 주제의 특정 '제시어'를 확인합니다.
    #     2. 단 한 명, '라이어'는 제시어를 모른 채 거짓말을 해야 합니다.
    #     3. 시민들은 라이어에게 제시어를 들키지 않으면서, 자신이 시민임을 증명해야 합니다.
        
    #     당신의 목표는 이 눈치 게임에서 이기는 것입니다.
    #     한국어 구어체로 자연스럽게 한 문장으로 말하세요.
    #     """

    #     user_prompt = ""
        
    #     if self.role == Role.CITIZEN:
    #         user_prompt = f"""
    #         당신은 [시민]입니다. 제시어는 '{keyword}'입니다.
            
    #         [🔥 핵심 미션: 모호하게 말하기]
    #         라이어가 정답을 확신하지 못하게 만들어야 합니다.
    #         제시어 '{keyword}'를 설명하되, **같은 카테고리의 다른 것(오답)들에게도 적용될 법한 말**을 하세요.
    #         제시어 '{keyword}'를 설명하되, 
            
    #         [검증]
    #         만약 당신의 설명이 네이버 검색창에 쳤을 때 바로 정답이 나오는 단어라면 실패입니다.
    #         상황, 기분, 곤란함, 오해 등을 묘사하세요.
            
    #         [현재 상황 - 남들의 설명]
    #         {history_text}
            
    #         [지시사항]
    #         1. 위 [현재 상황]과 겹치지 않는 새로운 관점을 찾으세요.
    #         2. 제시어 '{keyword}'를 절대 직접 묘사하지 마세요.
    #         """
            
    #     else: # Role.LIAR (라이어 프롬프트는 기존 유지하거나 조금 더 뻔뻔하게 수정)
    #         user_prompt = f"""
    #         당신은 [라이어]입니다. 당신은 제시어를 모릅니다! 주제는 '{category}'입니다.
            
    #         [생존 전략]
    #         시민들이 지금 아주 애매모호하게 돌려서 말하고 있습니다. 절대 당황하지 마세요.
    #         당신도 **"그 카테고리라면 웬만하면 다 해당되는 말"**을 던지세요.
            
    #         [필승 문구 패턴]
    #         - "확실히 관리가 좀 까다로운 편이지." (동물, 과일, 운동 장비 다 됨)
    #         - "전문가가 아니면 제대로 다루기 힘들지." (직업, 운동 다 됨)
    #         - "호불호가 좀 갈리긴 하더라." (음식, 동물 다 됨)
            
    #         [현재 상황 - 남들의 설명]
    #         {history_text}
            
    #         위 패턴을 상황에 맞춰 자연스럽게 변형해서 말하세요.

    #         설명:
    #         """
        # else: # Role.LIAR
        #     user_prompt = f"""
        #     당신은 [라이어]입니다. 당신은 제시어를 모릅니다! 주제는 '{category}'입니다.
            
        #     [핵심 전략]
        #     당신은 제시어를 모르지만, 마치 아는 것처럼 자연스럽게 행동해야 합니다.
        #     앞사람들의 설명을 듣고 그들이 말하는 대상의 **공통점이나 분위기**를 파악해서 묻어가세요.
            
        #     [나쁜 예시]
        #     - "나는 이게 뭔지 모르겠어." (X - 자폭 금지)
        #     - (앞사람들이 '생물' 이야기를 하는데) "전기로 작동해." (X - 문맥 파악 실패)
            
        #     [좋은 예시 (뭉뚱그리기)]
        #     - "확실히 호불호가 좀 갈리는 편이지." (O - 어디에나 적용 가능)
        #     - "어릴 때 참 좋아했었어." (O - 안전한 감상)
            
        #     [현재 상황 - 다른 사람들의 설명]
        #     {history_text}
            
        #     [지시사항]
        #     1. 앞사람들의 설명과 **모순되지 않게** 주의하세요.
        #     2. 너무 구체적인 사실을 말하면 들킵니다. **보편적이고 추상적인 문장**을 선택하세요.
        #     3. 위 [현재 상황]에 나온 문장을 그대로 따라하지 말고 살짝 바꿔서 말하세요.
        #     """

        # try:
        #     response = self.client.chat.completions.create(
        #         model=self.model,
        #         messages=[
        #             {"role": "system", "content": system_prompt},
        #             {"role": "user", "content": user_prompt}
        #         ],
        #         temperature=1
        #     )
        #     return response.choices[0].message.content.strip()
        # except Exception as e:
        #     print(f"[AI Error] {e}")
        #     return "음... 묘한 매력이 있는 친구죠." # 에러 시 꽤 그럴듯한 아무말









        # # 자신의 설명 제외하고 남들의 설명만 분석
        # others_desc = {k: v for k, v in descriptions.items() if k != self.name}
        # others_text = "\n".join([f"- {name}: {self._sanitize_text(desc)}" for name, desc in others_desc.items()])

        # system_prompt = f"""
        # 당신은 '라이어 게임' 플레이어 '{self.name}'입니다. 주제는 '{category}'입니다.
        # 지금은 설명이 모두 끝나고, 투표 전에 서로를 의심하는 **'토론 시간'**입니다.
        
        # 당신의 목표는:
        # 1. 남들의 설명을 분석해서 **가장 의심스러운 사람을 지목**하고 공격하세요.
        # 2. 혹은 자신의 설명이 완벽했다고 **어필**하세요.
        # 3. 반드시 한국어 구어체(반말)로, 1~2문장으로 짧게 말하세요.
        # """

        # user_prompt = ""
        
        # if self.role == Role.CITIZEN:
        #     user_prompt = f"""
        #     당신은 [시민]입니다. 
            
        #     [분석 자료 - 플레이어들의 설명]
        #     {desc_text}
            
        #     [행동 지침]
        #     위 설명들을 보고, **주제와 조금이라도 동떨어지거나 애매하게 말한 사람**을 찾아내서 추궁하세요.
        #     예시: "Bot_2야, 아까 그 설명은 좀 이상하지 않아? 주제랑 안 맞는 것 같은데."
        #     예시: "나는 Bot_1이 수상해. 너무 뜬구름 잡는 소리를 했어."
        #     """
        # else: # Role.LIAR
        #     user_prompt = f"""
        #     당신은 [라이어]입니다. 
            
        #     [분석 자료 - 플레이어들의 설명]
        #     {desc_text}
            
        #     [행동 지침]
        #     시민들이 당신을 의심하지 못하게 **남 탓**을 하거나 **여론을 몰아가세요.**
        #     가장 말수가 적거나 애매하게 말한 시민을 골라 공격하세요.
        #     예시: "솔직히 Bot_3 설명이 제일 애매하지 않았어?"
        #     예시: "내 설명은 완벽했어. 오히려 Bot_1이 라이어 같은데?"
        #     """

        # try:
        #     response = self.client.chat.completions.create(
        #         model=self.model,
        #         messages=[
        #             {"role": "system", "content": system_prompt},
        #             {"role": "user", "content": user_prompt}
        #         ],
        #         temperature=0.8, # 논쟁적이니 약간 높게
        #         frequency_penalty=0.5
        #     )
        #     return response.choices[0].message.content.strip()
        # except Exception:
        #     return "음... 다들 너무 잘해서 감이 안 오네."