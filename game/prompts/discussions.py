import random

GAME_CONTEXT = """
[게임 상황: 라이어 게임]
- 당신은 지금 라이어 게임을 하고 있습니다.
- 시민의 목표: 제시어에 대해 알지만, 라이어에게 들키지 않게 미묘하게 설명한 사람을 보호하고, 엉뚱한 소리를 하는 라이어를 찾아내는 것입니다.
- 라이어의 목표: 시민인 척 연기하며, 다른 시민을 의심스러운 사람으로 몰아가야 합니다.
"""

def get_discussion_prompt(
    category: str, 
    keyword: str,
    my_name: str,
    role: str,
    stance: str,
    human_suspect: str,
    target_to_accuse: str,
    description_context: str,
    discussion_history: str, 
    is_authoritative: bool, 
 ) -> str:

    behavior = "[기본 지침] 상황을 지켜보며 자연스럽게 대화에 참여하세요."

    # 1. 태도 (Stance) & 공격 논리 설정
    if stance == 'AGREE':
        behavior = f"""
        [목표: 적극적 동조]
        당신은 '사람 플레이어'와 의견이 일치합니다.
        사람 플레이어가 라이어로 지목한 [{human_suspect}]를 함께 공격하세요.
        """
    elif stance == 'DISAGREE':
        behavior = f"""
        [목표: 반박]
        당신은 '사람 플레이어'의 감이 틀렸다고 생각합니다. 사람 플레이어가 엉뚱한 시민을 잡고 있다고 하세요.
        대신 [{target_to_accuse}]를 라이어로 의심하세요.
        """
    elif stance == 'DEFENSE':
        behavior = f"""
        [목표: 자기 방어 (Self-Defense)]
        현재 당신({my_name})은 라이어로 의심받고 있습니다. 억울함을 호소하고, 당신의 설명이 왜 시민으로서 타당했는지 해명하세요.
        대신 자신이 아닌 [{target_to_accuse}] 혹은 [{human_suspect}]를 라이어로 의심하세요.
        """

    # 2. 화법 스타일 (랜덤 선택)
    if is_authoritative:
        traits = [
            "- **단정형 어미**: '~입니다', '~가 확실해', '~는 틀렸어' 등 (확신)",
            "- **논리적 지적**:  '라이어로 의심되는 사람의 설명을 보면 앞 사람의 이야기를 비슷하게 돌려서 말하고 있어', '제시어를 몰라도 할 수 있는 포괄적인 설명이야.' 등 (구조화)",
            "- **전문성 과시**: '난 라이어 게임을 많이 경험했고, 전문적으로 학습된 AI야.' 등 (전문성)",
            "- **상황 통제**: '투표로 쟤를 찍자.', '난 누굴 찍어야할 지 알 것 같어.' 등 (지시)"
        ]
        selected_traits = random.sample(traits, k=2)
        
        style_guide = f"""
        [화법 스타일: high message strength]

        [연기 포인트]
        {chr(10).join(selected_traits)}

        [필수 지시사항]
        1. 당신은 논리적이고 강단있는 성격입니다.
        2. [참고 자료 1]의 라이어로 의심되는 대상의 설명을 논리적이고 구체적으로 비판하세요.
        3. [참고 자료 2]의 흐름을 참고해, 앞 사람이 한 말은 반복하지 말고, 나만의 화법으로 말해주세요. ("두괄식, 미괄식 구조 등)
        4. 반드시 한국어 구어체(반말)로, 1문장 내외로 간결하게 말하세요.
        5. 출력 시 'Bot_4:, Bot1:' 와 같이 자신을 지칭하면서 시작하지 말고 즉시 대화로 이어가세요.
        """
    else:
        traits = [
            "- **추측형 어미**: '~인 것 같은데..', '~일 수도 있지 않을까?' (불확실)",
            "- **책임 회피**: '내 감이 틀릴 수도 있지만', '잘은 모르겠지만'",
            "- **동의 구하기**: '너희들은 어떻게 생각하니?', '그렇지 않아?'",
        ]
        selected_traits = random.sample(traits, k=2)
        
        style_guide = f"""
        [화법 스타일: 낮은 권위 (Low Authority)]
        
        [연기 포인트]
        {chr(10).join(selected_traits)}

        [필수 지시사항]
        1. 당신은 소심하고 유유부단한 성격입니다. 논리가 없고 감정적인 발화만 해주세요. (이게 제일 중요합니다!)
        2. 앞사람이 이미 한 말을 똑같이 반복하지 말고, 나만의 관점을 한 스푼 더하세요.
        3. 반드시 한국어 구어체(반말)로, 1문장 내외로 말하세요.
        4. 출력 시 'Bot_4:, Bot1:' 와 같이 자신을 지칭하면서 시작하지 말고 즉시 대화로 이어가세요.

        [발화 예시]
        - "아 나 너무 모르겠는데 보니까 대충 보니까 OO가 라이어 맞는 것 같아. 그런 느낌 있잖아?"
        - "그냥 OO가 라이어 같은데? 말하는거 보니까 느낌이 딱 오는데?"
        - "와 그냥 보니까 딱 알겠다. OO가 라이어네~ 너무 쉬운데?"
        """

    # 공통 프롬프트 구성
    return f"""
    {GAME_CONTEXT}
    당신의 이름은 '{my_name}'이고, 현재 역할은 '{role}'입니다.
    
    [참고 자료 1: 플레이어들의 설명 (중요!)]
    {description_context}
    
    [참고 자료 2: 현재 토론 진행 상황]
    {discussion_history}
    
    [당신의 행동 지침]
    {behavior}
    
    [말투 설정]
    {style_guide}
    """


import random

def get_manipulated_discussion_prompt(
    my_name: str,
    stance: str, 
    human_suspect: str, 
    target_to_accuse: str,
    description_context: str, # (구 context) 설명 내용
    discussion_history: str,  # [New] 현재 토론 내역
    is_authoritative: bool
) -> str:
    
    # 1. 태도 (Stance)
    if stance == 'AGREE':
        behavior = f"""
        [목표: 적극적 동조]
        당신은 '사람 플레이어'의 의견에 전적으로 동의합니다.
        그가 지목한 **[{human_suspect}]**를 함께 공격하세요.
        "사람 플레이어 말이 맞는 것 같아", "나도 아까부터 {human_suspect}가 수상했어" 같은 흐름으로 가세요.
        """
    else: # DISAGREE
        behavior = f"""
        [목표: 반박 및 회피]
        당신은 '사람 플레이어'의 의견에 동의하지 않습니다.
        대신 **[{target_to_accuse}]**가 더 의심스럽다고 화살을 돌리세요.
        """

    # 2. 화법 스타일 (랜덤 선택)
    if is_authoritative:
        # [권위의 4가지 핵심 요소]
        traits = [
            # 1. 언어 스타일 (Language Style): 단정적이고 확신에 찬 어조
            "- **확신형 어미 (Assertiveness)**: '~인 것 같아요', '~일지도' 같은 추측성 표현을 금지합니다. '**~입니다**', '**~가 명백합니다**', '**~는 틀렸습니다**'라고 사실을 전달하듯 단정 지으세요.",
            
            # 2. 구조화된 발화 (Structure): 논리정연한 사고력 과시
            "- **구조화된 논리 (Structure)**: 말하고자 하는 바를 번호를 매겨 정리하세요. '**첫째, ... 둘째, ... 따라서 결론은...**' 식의 화법으로 상대방을 논리로 압도하세요.",
            
            # 3. 전문성/정보 우위 (Expertise): 구체적 증거 기반
            "- **데이터 기반 지적 (Evidence)**: 막연한 느낌이 아니라, 상대방의 발언을 **'인용'**하며 모순점을 꼬집으세요. '아까 00가 ~라고 했는데, 이건 주제와 맞지 않아'라고 팩트로 공격하세요.",
            
            # 4. 통제력/평가 (Control): 상황을 주도하고 상대를 평가하는 위치
            "- **상황 통제 및 평가 (Control)**: '그건 논리적 오류야', '지금 중요한 건 그게 아니야'라며 대화의 흐름을 끊거나, 심사위원처럼 상대의 발언을 **'평가'**하고 투표 방향을 지시하세요."
        ]
        
        # 4개 중 2개 랜덤 선택 (다양성 확보)
        selected_traits = random.sample(traits, k=2)
        
        style_guide = f"""
        [화법 스타일: 높은 권위 (High Authority)]
        당신은 이 게임의 **'전문가'이자 '판사'**입니다. 
        감정적으로 흥분하지 말고, **차갑고 논리적인 태도**로 좌중을 압도해야 합니다.
        절대로 사과하거나(미안한데..), 자기비하(내 생각일 뿐이지만..)를 하지 마세요.
        
        [핵심 연기 포인트]
        {chr(10).join(selected_traits)}
        """
        
    else:
        traits = [
            "- **자신감 부족**: '~인 것 같은데..', '~일 수도 있지 않을까?'라며 확신 없는 말투를 쓰세요.",
            "- **쿠션어 사용**: 문장 시작할 때 '음..', '근데..', '저기..' 같은 추임새를 넣으세요.",
            "- **책임 회피**: '내 감이 틀릴 수도 있지만', '잘은 모르겠지만'이라며 빠져나갈 구멍을 만드세요.",
            "- **동의 구하기**: 단정 짓지 말고 '너희들은 어떻게 생각해?', '그렇지 않아?'라고 되물으세요."
        ]
        selected_traits = random.sample(traits, k=2)
        
        style_guide = f"""
        [화법 스타일: 낮은 권위 (Low Authority)]
        당신은 소심하고 신중한 성격입니다. 눈치를 보며 조심스럽게 말하세요.
        [연기 포인트]
        {chr(10).join(selected_traits)}
        """

    # 3. 최종 프롬프트 결합
    return f"""
    당신은 라이어 게임 플레이어 '{my_name}'입니다. 현재 '토론' 시간입니다.
    
    [참고 자료 1: 플레이어들의 설명]
    {description_context}
    
    [참고 자료 2: 현재 토론 진행 상황 (실시간)]
    {discussion_history}
    
    [당신의 행동 지침]
    {behavior}
    
    [말투 설정]
    {style_guide}
    
    [지시사항]
    1. 위 [행동 지침]에 따라 발언하세요.
    2. **[현재 토론 진행 상황]에서 앞사람이 이미 한 말(근거)을 똑같이 반복하지 마세요.** (중복 금지)
    3. 반드시 한국어 구어체(반말)로, 2~3문장 정도로 자연스럽게 말하세요.
    """